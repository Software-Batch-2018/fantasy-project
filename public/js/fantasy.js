var players = [{"Player_name":"Adrien Rabiot","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250053905.jpg","Player_price":2.2},{"Player_name":"Antoine Griezmann","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250019498.jpg","Player_price":3.7},{"Player_name":"Benjamin Pavard","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250081921.jpg","Player_price":2},{"Player_name":"Clément Lenglet","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250042779.jpg","Player_price":1.8},{"Player_name":"Corentin Tolisso","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250054829.jpg","Player_price":2.3},{"Player_name":"Hugo Lloris","Player_position":"GK","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/93846.jpg","Player_price":2},{"Player_name":"Jules Koundé","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250096309.jpg","Player_price":1.5},{"Player_name":"Karim Benzema","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/93321.jpg","Player_price":3.3},{"Player_name":"Kingsley Coman","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250054949.jpg","Player_price":3.2},{"Player_name":"Kurt Zouma","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250024983.jpg","Player_price":1.7},{"Player_name":"Kylian Mbappé","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250076574.jpg","Player_price":4},{"Player_name":"Léo Dubois","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250088023.jpg","Player_price":1.5},{"Player_name":"Lucas Digne","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250014002.jpg","Player_price":2},{"Player_name":"Lucas Hernandez","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250063803.jpg","Player_price":2.2},{"Player_name":"Marcus Thuram","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250068805.jpg","Player_price":2.5},{"Player_name":"Mike Maignan","Player_position":"GK","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250042780.jpg","Player_price":1.3},{"Player_name":"Moussa Sissoko","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/103722.jpg","Player_price":1.7},{"Player_name":"NGolo Kanté","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250097248.jpg","Player_price":1.8},{"Player_name":"Olivier Giroud","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250020851.jpg","Player_price":2.7},{"Player_name":"Ousmane Dembélé","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250066886.jpg","Player_price":2.8},{"Player_name":"Paul Pogba","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250015808.jpg","Player_price":2.8},{"Player_name":"Presnel Kimpembe","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250064583.jpg","Player_price":1.8},{"Player_name":"Raphaël Varane","Player_position":"DF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250025891.jpg","Player_price":2},{"Player_name":"Steve Mandanda","Player_position":"GK","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/98893.jpg","Player_price":1.5},{"Player_name":"Thomas Lemar","Player_position":"MF","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250042778.jpg","Player_price":2.2},{"Player_name":"Wissam Ben Yedder","Player_position":"FW","teamName":"France","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250025970.jpg","Player_price":2.3},{"Player_name":"Antonio Rüdiger","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250028211.jpg","Player_price":1.8},{"Player_name":"Bernd Leno","Player_position":"GK","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250007620.jpg","Player_price":1.7},{"Player_name":"Christian Günter","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250062174.jpg","Player_price":1.5},{"Player_name":"Emre Can","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250017824.jpg","Player_price":1.8},{"Player_name":"Florian Neuhaus","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250112854.jpg","Player_price":1.7},{"Player_name":"İlkay Gündoğan","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250005335.jpg","Player_price":2.5},{"Player_name":"Jamal Musiala","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250124430.jpg","Player_price":1.8},{"Player_name":"Jonas Hofmann","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250057117.jpg","Player_price":1.8},{"Player_name":"Joshua Kimmich","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250070417.jpg","Player_price":2},{"Player_name":"Kai Havertz","Player_position":"FW","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250087938.jpg","Player_price":3},{"Player_name":"Kevin Trapp","Player_position":"GK","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/1902188.jpg","Player_price":1.5},{"Player_name":"Kevin Volland","Player_position":"FW","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250023705.jpg","Player_price":2.8},{"Player_name":"Leon Goretzka","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250041771.jpg","Player_price":2.2},{"Player_name":"Leroy Sané","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250063984.jpg","Player_price":3.2},{"Player_name":"Lukas Klostermann","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250058260.jpg","Player_price":1.5},{"Player_name":"Manuel Neuer","Player_position":"GK","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/97923.jpg","Player_price":2},{"Player_name":"Marcel Halstenberg","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250057119.jpg","Player_price":1.5},{"Player_name":"Mats Hummels","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/106587.jpg","Player_price":1.7},{"Player_name":"Matthias Ginter","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250055962.jpg","Player_price":1.7},{"Player_name":"Niklas Süle","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250041781.jpg","Player_price":1.8},{"Player_name":"Robin Gosens","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250062606.jpg","Player_price":1.7},{"Player_name":"Robin Koch","Player_position":"DF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250126501.jpg","Player_price":1.5},{"Player_name":"Serge Gnabry","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250041770.jpg","Player_price":3.2},{"Player_name":"Thomas Müller","Player_position":"FW","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250003318.jpg","Player_price":2.3},{"Player_name":"Timo Werner","Player_position":"FW","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/250049183.jpg","Player_price":2.8},{"Player_name":"Toni Kroos","Player_position":"MF","teamName":"Germany","Player_image":"https://img.uefa.com/imgml/TP/players/3/2020/324x324/103147.jpg","Player_price":3}]
let GK = document.getElementById('goal')
let DF = document.getElementById('def')
let MF = document.getElementById('mid')
let FW = document.getElementById('forward')

let price_div = document.getElementById('fantasy-price')
let price = document.getElementById('fantasy-price').textContent
price = parseFloat(price)


var map = new Map()
var user_pick = '{"theTeam":[]}'


function filterbyPosition(position){
    var result = players.filter( element => element.Player_position ==position)
    return result
}

function myFunction(id) {
    var popup = document.getElementById("myPopup");
    var new_id = id.substring(0, 2)
    var filtered_players = filterbyPosition(new_id)
    var output = " "
    output += `<div class="leaderboard" onclick = "hide_col()">
    <h1>
      ${new_id}
    </h1>
    <ol>`
    for (var i = 0; i < filtered_players.length; i++) {
      output += `
      <li data-item='${JSON.stringify(filtered_players[i])}' onclick="addplayer(this, '${id}')">
        <img class="head-image" src="${filtered_players[i].Player_image}" >
        <mark>${filtered_players[i].Player_name}</mark>
        <small>$ ${filtered_players[i].Player_price} m</small>
      </li>   
      `
    }
    output += '</ol></div>'
    popup.innerHTML = output
    popup.classList.toggle("show");
    popup.style.display = "block"
}


function hide_col(){
  var element = document.getElementById("myPopup");
  element.style.display = "none";
}





//formation logic

function formation(){

  document.getElementById('fantasy-price').textContent = 12
  addPlayerToArray('reset')
  map = new Map()
  
  let defender = " "
  let midfielder = " "
  let forward = " "

  let position  = {'GK': 1, 'DF': 0, 'MF': 0, 'FW':0}
  var formation = document.getElementById("formation").value;
  var numb = formation.match(/\d/g);
  numb = numb.join("");
  var array = Array.from(String(numb), Number)
  position['DF'] = array[1]
  position['MF'] = array[2]
  position['FW'] = array[3]

  GK.innerHTML = `<div class="player" id="GK" onclick="myFunction(this.id)"><div class="select-card"><img class="card-image" src="/img/add.png" ><br>GK</div></div>`

  for (let index = 0; index < position['DF']; index++) {
    defender += `<div class="player" id="DF DF${index}" onclick="myFunction(this.id)"><div class="select-card"><img class="card-image" src="/img/add.png" ><br>DF</div></div>`
  }
  DF.innerHTML = defender

  for (let index = 0; index < position['MF']; index++) {
    midfielder += `<div class="player" id="MF MF${index}" onclick="myFunction(this.id)"><div class="select-card"><img class="card-image" src="/img/add.png" ><br>MF</div></div>`
  }
  MF.innerHTML = midfielder

  for (let index = 0; index < position['FW']; index++) {
    forward += `<div class="player" id="FW FW${index}" onclick="myFunction(this.id)"><div class="select-card"><img class="card-image" src="/img/add.png" ><br>FW</div></div>`
  }
  FW.innerHTML = forward

}


//add player
function addplayer(data, id){
  let player = JSON.parse(data.dataset.item)  
  let player_id = document.getElementById(id)
  
  //player repeat prevent
  if(map[player.Player_name]){
    return
  }

  if(map[id]){
    user_pick = JSON.parse(user_pick)
    for (let [i, players] of user_pick['theTeam'].entries()) {
      if (players.Player_name == map[id]){
        map[players.teamName] -=1
        price_tracker(-players.Player_price)
        user_pick['theTeam'].splice(i, 1);   
        user_pick = JSON.stringify(user_pick)   
        delete(map[players.Player_name])
      }
   }
  }



  //player name splitting
  let name = player.Player_name
  let arr = name.split(' ');
  if(arr[1]){
    name = arr[1]
  }
  else{
    name = arr[0]
  }

  //team count
  if(map[player.teamName] == 3){
    return
  }else if(!map[player.teamName]){
    map[player.teamName] = 1
  }else{
    map[player.teamName] +=1
  }


  //final decision
  let decision = price_tracker(player.Player_price)
  if(decision == false){
    return
  }
  else{
    player_id.innerHTML = " "
    player_id.innerHTML = `<div class="select-card"><img class="card-image" src="${player.Player_image}" ><br>${name}<br>$${player.Player_price}m</div>`
  
    addPlayerToArray(player)
    map[player.Player_name] = player.Player_name
    map[id] = player.Player_name
  }
}



//add player to array for sending it to server
function addPlayerToArray(player){
  if(player == 'reset'){
    user_pick = '{"theTeam":[]}'
    return user_pick
  }else{
    user_pick = JSON.parse(user_pick)
    user_pick['theTeam'].push(player);
    var player_number = document.getElementById('player-number')
    var num = user_pick['theTeam'].length
    if(num == 5){
      document.getElementById('btn').style.display = 'block'
    }
    player_number.innerHTML = num
    user_pick = JSON.stringify(user_pick)
    return user_pick
  }
}


//price tracker
function price_tracker(money){
  let price_div = document.getElementById('fantasy-price')
  let price = document.getElementById('fantasy-price').textContent
  price = parseFloat(price)
  
  price = price - money
  if(price<0){
    return false
  }else{
  price_div.innerHTML = price.toFixed(1)
  }
}


let send_data = document.querySelectorAll('.btn')
send_data.forEach((btn)=>{
  btn.addEventListener('click',(e)=>{
    $('#btn').hide();
      fetch('http://localhost:4000/fantasy/', {
        method: 'POST',
        redirect: 'follow',
        headers: {
            'Content-Type': 'application/json'
        },
        body:user_pick
    }).then(res=>{
      window.location.replace(res.url);
    });
  })
})








